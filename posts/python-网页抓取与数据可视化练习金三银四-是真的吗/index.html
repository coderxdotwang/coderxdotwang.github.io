<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？ | 编程蚂蚁</title><meta name=keywords content="Python"><meta name=description content="一年之计在于春，2020 的春天因为疫情可能改变了许多人的计划，如三四月份是企业传统招聘高峰期之一，再有许多帅小伙过年拜见了丈母娘催促着得买房等，职场与楼市素有 ‘金三银四’ 的说法，然而，这是真的吗？
最近又学习了一下 Python（为什么是又？因为学了就忘..），想到何不简单验证一下，毕竟数据不会撒谎。
 主要流程：
 选取楼市情况作为分析对象，与目前公司业务有点相关性。 从 武汉市住房保障和房屋管理局 网站获取公开的新建商品房成交统计数据。 读取数据并可视化，结合图表简要分析得出初步结论。   先贴最终生成的可视化数据图：
1、获取数据 先使用 ‘为人类设计的 HTTP 库’ - requests 从房管局网站上获取包含公开成交统计数据的 HTML 页面，数据分为按日统计发布的及按月统计发布的。然后使用 HTML 与 XML 处理库 lxml 解析 HTML 页面内容，分析后通过合适的 xpath 提取所需数据。
最开始我的想法是读取每日数据再分别计算出每个月的数据，爬完后发现目录页下面紧挨着的就是按月统计数据（笑哭.jpg ，但是按月的数据只发布到了2019年11月，连整两年都凑不足可不行，于是结合按日统计数据（发布到了2020年01月23日）计算出了2019年12月的数据，果然人生没有白走的路：）
import requests import lxml.html import html import time  import db_operator  def get_all_monthly_datas():  &#34;&#34;&#34;按月获取所有成交数据&#34;&#34;&#34;  # 索引页（商品住房销售月度成交统计）  index_url = 'http://fgj.wuhan.gov.cn/spzfxysydjcjb/index.jhtml'  max_page = get_max_page(index_url)  if max_page > 0:  print('共 ' + str(max_page) + ' 页，' + '开始获取月度数据."><meta name=author content><link rel=canonical href=https://coderx.wang/posts/python-%E7%BD%91%E9%A1%B5%E6%8A%93%E5%8F%96%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%83%E4%B9%A0%E9%87%91%E4%B8%89%E9%93%B6%E5%9B%9B-%E6%98%AF%E7%9C%9F%E7%9A%84%E5%90%97/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://coderx.wang/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coderx.wang/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coderx.wang/favicon-32x32.png><link rel=apple-touch-icon href=https://coderx.wang/apple-touch-icon.png><link rel=mask-icon href=https://coderx.wang/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？"><meta property="og:description" content="一年之计在于春，2020 的春天因为疫情可能改变了许多人的计划，如三四月份是企业传统招聘高峰期之一，再有许多帅小伙过年拜见了丈母娘催促着得买房等，职场与楼市素有 ‘金三银四’ 的说法，然而，这是真的吗？
最近又学习了一下 Python（为什么是又？因为学了就忘..），想到何不简单验证一下，毕竟数据不会撒谎。
 主要流程：
 选取楼市情况作为分析对象，与目前公司业务有点相关性。 从 武汉市住房保障和房屋管理局 网站获取公开的新建商品房成交统计数据。 读取数据并可视化，结合图表简要分析得出初步结论。   先贴最终生成的可视化数据图：
1、获取数据 先使用 ‘为人类设计的 HTTP 库’ - requests 从房管局网站上获取包含公开成交统计数据的 HTML 页面，数据分为按日统计发布的及按月统计发布的。然后使用 HTML 与 XML 处理库 lxml 解析 HTML 页面内容，分析后通过合适的 xpath 提取所需数据。
最开始我的想法是读取每日数据再分别计算出每个月的数据，爬完后发现目录页下面紧挨着的就是按月统计数据（笑哭.jpg ，但是按月的数据只发布到了2019年11月，连整两年都凑不足可不行，于是结合按日统计数据（发布到了2020年01月23日）计算出了2019年12月的数据，果然人生没有白走的路：）
import requests import lxml.html import html import time  import db_operator  def get_all_monthly_datas():  &#34;&#34;&#34;按月获取所有成交数据&#34;&#34;&#34;  # 索引页（商品住房销售月度成交统计）  index_url = 'http://fgj.wuhan.gov.cn/spzfxysydjcjb/index.jhtml'  max_page = get_max_page(index_url)  if max_page > 0:  print('共 ' + str(max_page) + ' 页，' + '开始获取月度数据."><meta property="og:type" content="article"><meta property="og:url" content="https://coderx.wang/posts/python-%E7%BD%91%E9%A1%B5%E6%8A%93%E5%8F%96%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%83%E4%B9%A0%E9%87%91%E4%B8%89%E9%93%B6%E5%9B%9B-%E6%98%AF%E7%9C%9F%E7%9A%84%E5%90%97/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-19T22:42:41+00:00"><meta property="article:modified_time" content="2020-03-19T22:42:41+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？"><meta name=twitter:description content="一年之计在于春，2020 的春天因为疫情可能改变了许多人的计划，如三四月份是企业传统招聘高峰期之一，再有许多帅小伙过年拜见了丈母娘催促着得买房等，职场与楼市素有 ‘金三银四’ 的说法，然而，这是真的吗？
最近又学习了一下 Python（为什么是又？因为学了就忘..），想到何不简单验证一下，毕竟数据不会撒谎。
 主要流程：
 选取楼市情况作为分析对象，与目前公司业务有点相关性。 从 武汉市住房保障和房屋管理局 网站获取公开的新建商品房成交统计数据。 读取数据并可视化，结合图表简要分析得出初步结论。   先贴最终生成的可视化数据图：
1、获取数据 先使用 ‘为人类设计的 HTTP 库’ - requests 从房管局网站上获取包含公开成交统计数据的 HTML 页面，数据分为按日统计发布的及按月统计发布的。然后使用 HTML 与 XML 处理库 lxml 解析 HTML 页面内容，分析后通过合适的 xpath 提取所需数据。
最开始我的想法是读取每日数据再分别计算出每个月的数据，爬完后发现目录页下面紧挨着的就是按月统计数据（笑哭.jpg ，但是按月的数据只发布到了2019年11月，连整两年都凑不足可不行，于是结合按日统计数据（发布到了2020年01月23日）计算出了2019年12月的数据，果然人生没有白走的路：）
import requests import lxml.html import html import time  import db_operator  def get_all_monthly_datas():  &#34;&#34;&#34;按月获取所有成交数据&#34;&#34;&#34;  # 索引页（商品住房销售月度成交统计）  index_url = 'http://fgj.wuhan.gov.cn/spzfxysydjcjb/index.jhtml'  max_page = get_max_page(index_url)  if max_page > 0:  print('共 ' + str(max_page) + ' 页，' + '开始获取月度数据."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://coderx.wang/posts/"},{"@type":"ListItem","position":2,"name":"Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？","item":"https://coderx.wang/posts/python-%E7%BD%91%E9%A1%B5%E6%8A%93%E5%8F%96%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%83%E4%B9%A0%E9%87%91%E4%B8%89%E9%93%B6%E5%9B%9B-%E6%98%AF%E7%9C%9F%E7%9A%84%E5%90%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？","name":"Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？","description":"一年之计在于春，2020 的春天因为疫情可能改变了许多人的计划，如三四月份是企业传统招聘高峰期之一，再有许多帅小伙过年拜见了丈母娘催促着得买房等，职场与楼市素有 ‘金三银四’ 的说法，然而，这是真的吗？\n最近又学习了一下 Python（为什么是又？因为学了就忘..），想到何不简单验证一下，毕竟数据不会撒谎。\n 主要流程：\n 选取楼市情况作为分析对象，与目前公司业务有点相关性。 从 武汉市住房保障和房屋管理局 网站获取公开的新建商品房成交统计数据。 读取数据并可视化，结合图表简要分析得出初步结论。   先贴最终生成的可视化数据图：\n1、获取数据 先使用 ‘为人类设计的 HTTP 库’ - requests 从房管局网站上获取包含公开成交统计数据的 HTML 页面，数据分为按日统计发布的及按月统计发布的。然后使用 HTML 与 XML 处理库 lxml 解析 HTML 页面内容，分析后通过合适的 xpath 提取所需数据。\n最开始我的想法是读取每日数据再分别计算出每个月的数据，爬完后发现目录页下面紧挨着的就是按月统计数据（笑哭.jpg ，但是按月的数据只发布到了2019年11月，连整两年都凑不足可不行，于是结合按日统计数据（发布到了2020年01月23日）计算出了2019年12月的数据，果然人生没有白走的路：）\nimport requests import lxml.html import html import time  import db_operator  def get_all_monthly_datas():  \u0026#34;\u0026#34;\u0026#34;按月获取所有成交数据\u0026#34;\u0026#34;\u0026#34;  # 索引页（商品住房销售月度成交统计）  index_url = \u0026#39;http://fgj.wuhan.gov.cn/spzfxysydjcjb/index.jhtml\u0026#39;  max_page = get_max_page(index_url)  if max_page \u0026gt; 0:  print(\u0026#39;共 \u0026#39; + str(max_page) + \u0026#39; 页，\u0026#39; + \u0026#39;开始获取月度数据.","keywords":["Python"],"articleBody":"一年之计在于春，2020 的春天因为疫情可能改变了许多人的计划，如三四月份是企业传统招聘高峰期之一，再有许多帅小伙过年拜见了丈母娘催促着得买房等，职场与楼市素有 ‘金三银四’ 的说法，然而，这是真的吗？\n最近又学习了一下 Python（为什么是又？因为学了就忘..），想到何不简单验证一下，毕竟数据不会撒谎。\n 主要流程：\n 选取楼市情况作为分析对象，与目前公司业务有点相关性。 从 武汉市住房保障和房屋管理局 网站获取公开的新建商品房成交统计数据。 读取数据并可视化，结合图表简要分析得出初步结论。   先贴最终生成的可视化数据图：\n1、获取数据 先使用 ‘为人类设计的 HTTP 库’ - requests 从房管局网站上获取包含公开成交统计数据的 HTML 页面，数据分为按日统计发布的及按月统计发布的。然后使用 HTML 与 XML 处理库 lxml 解析 HTML 页面内容，分析后通过合适的 xpath 提取所需数据。\n最开始我的想法是读取每日数据再分别计算出每个月的数据，爬完后发现目录页下面紧挨着的就是按月统计数据（笑哭.jpg ，但是按月的数据只发布到了2019年11月，连整两年都凑不足可不行，于是结合按日统计数据（发布到了2020年01月23日）计算出了2019年12月的数据，果然人生没有白走的路：）\nimport requests import lxml.html import html import time  import db_operator  def get_all_monthly_datas():  \"\"\"按月获取所有成交数据\"\"\"  # 索引页（商品住房销售月度成交统计）  index_url = 'http://fgj.wuhan.gov.cn/spzfxysydjcjb/index.jhtml'  max_page = get_max_page(index_url)  if max_page  0:  print('共 ' + str(max_page) + ' 页，' + '开始获取月度数据..\\n')  for index in range(1, max_page + 1):  if index = 2:  index_url = 'http://fgj.wuhan.gov.cn/spzfxysydjcjb/index_' + str(index) + '.jhtml'  detail_urls = get_detail_urls(index, index_url)  for detail_url in detail_urls:  print('正在获取月度统计详情：' + detail_url)  monthly_detail_html_str = request_html(detail_url)  if monthly_detail_html_str:  find_and_insert_monthly_datas(monthly_detail_html_str)  else:  print('总页数为0。')   def request_html(target_url):  \"\"\"请求指定 url 页面\"\"\"  headers = {  'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Mobile Safari/537.36',  }  html_response = requests.get(target_url, headers=headers)  html_bytes = html_response.content  html_str = html_bytes.decode()  return html_str   def get_max_page(index_url) - int:  \"\"\"从索引页中获取总页数\"\"\"  print('获取总页数中..')  index_html_str = request_html(index_url)  selector = lxml.html.fromstring(index_html_str)  max_page_xpath = '//div[@class=\"whj_padding whj_color pages\"]/text()'  result = selector.xpath(max_page_xpath)  if result and len(result)  0:  result = result[0]  index_str = result.replace('\\r', '').replace('\\n', '').replace('\\t', '')  max_page = index_str.split('\\xa0')[0]  max_page = max_page.split('/')[1]  return int(max_page)  return 0   def get_detail_urls(index, index_url):  \"\"\"获取统计数据详情页 url 列表\"\"\"  print('正在获取统计列表页面数据:' + index_url + '\\n')  index_html_str = request_html(index_url)  selector = lxml.html.fromstring(index_html_str)  # 提取 url 列表。  # 疑问：这里使用 '//div[@class=\"fr hers\"]/ul/li/a/@href' 期望应该能提取到更准确的数据，但是结果为空  detail_urls_xpath = '//div/ul/li/a/@href'  detail_urls = selector.xpath(detail_urls_xpath)  return detail_urls 2、保存数据 获取到数据后需要保存下来，以便后续的数据处理与增量更新等。这里使用与 Python 相亲相爱的文档型数据库 MongoDB 存储数据。\n 踩坑：对于 macOS 系统网上许多 MongoDB 安装说明已经失效，需要参考 mongodb/homebrew-brew 引导安装。\n 启动服务后就可以写入数据：\nfrom pymongo import MongoClient from pymongo import collection from pymongo import database  client: MongoClient = MongoClient() db_name: str = 'housing_deal_data' col_daily_name: str = 'wuhan_daily' col_monthly_name: str = 'wuhan_monthly' database: database.Database = client[db_name] col_daily: collection = database[col_daily_name] col_monthly: collection = database[col_monthly_name]   def insert_monthly_data(year_month, monthly_commercial_house):  \"\"\"写入月度统计数据\"\"\"  query = {'year_month': year_month}  existed_row = col_monthly.find_one(query)  try:  monthly_commercial_house_value = int(monthly_commercial_house)  except:  if existed_row:  print('月度数据已存在 =')  col_monthly.delete_one(query)  print('已删除：月度成交数不符合期望。\\n')  else:  print('忽略：月度成交数不符合期望。\\n')  else:  print(str({year_month: monthly_commercial_house_value}))  item = {'year_month': year_month,  'commercial_house': monthly_commercial_house_value,}  if existed_row:  print('月度数据已存在 =')  new_values = {'$set': item}  result = col_monthly.update_one(query, new_values)  print('更新数据成功：' + str(item) + '\\n' + 'result：' + str(result) + '\\n')  else:  result = col_monthly.insert_one(item)  print('写入数据成功：' + str(item) + '\\n' + 'result：' + str(result) + '\\n') 由于在实践过程中提取数据限制不够严格导致前期写入了一些脏数据，所以这里除了正常的 insert、update 之外，还有一个 try-except 用来清理脏数据。\n3、读取数据 获取并保存数据执行完成后，使用 MongoDB GUI 工具 Robo 3T 查看，总体确认数据完整基本符合期望。\n接下来从数据库读取数据：\ndef read_all_monthly_datas():  \"\"\"从数据库读取所有月度统计数据\"\"\"  return {\"2018年\": read_monthly_datas('2018'),  \"2019年\": read_monthly_datas('2019'),}   def read_monthly_datas(year: str) - list:  \"\"\"从数据库读取指定年份的月度统计数据\"\"\"  query = {'year_month': {'$regex': '^' + year}}  result = col_monthly.find(query).limit(12).sort('year_month')   monthly_datas = {}  for data in result:  year_month = data['year_month']  commercial_house = data['commercial_house']  if commercial_house  0:  month_key = year_month.split('-')[1]  monthly_datas[month_key] = data['commercial_house']   # 如果读取结果小于 12，即有月度数据缺失，则尝试读取每日数据并计算出该月统计数据  if len(monthly_datas)  12:  for month in range(1, 13):  month_key = \"{:02d}\".format(month)  if month_key not in monthly_datas.keys():  print('{}年{}月 数据缺失..'.format(year, month_key))  commercial_house = get_month_data_from_daily_datas(year, month_key)  if commercial_house  0:  monthly_datas[month_key] = commercial_house  return monthly_datas   def get_month_data_from_daily_datas(year: str, month: str) - int:  \"\"\"从每日数据中计算月度统计数据\"\"\"  print('从每日数据中获取 {}年{}月 数据中..'.format(year, month))  query = {'year_month_day': {'$regex': '^({}-{})'.format(year, month)}}  result = col_daily.find(query).limit(31)  sum = 0  for daily_data in result:  daily_num = daily_data['commercial_house']  sum += daily_num  print('{}年{}月数据：{}'.format(year, month, sum))  return sum 可以看到读取月度数据方法中有校验数据是否完整以及数据缺失则从每日数据中读取计算相关的逻辑。\n4、数据可视化 由于只是练习简单查看数据总体趋势，所以没有想要绘制稍复杂的图表，使用图表库 matplotlib 绘制简单统计图：\nimport matplotlib.pyplot as plt import html_spider import db_operator  def generate_plot(all_monthly_datas):  \"\"\"生成统计图表\"\"\"  # 处理汉字未正常显示问题  # 还需要手动下载 SimHei.ttf 字体并放到 /venv/lib/python3.7/site-packages/matplotlib/mpl-data/fonts 目录下）  plt.rcParams['font.sans-serif'] = ['SimHei']  plt.rcParams['font.family'] = 'sans-serif'   # 生成统计图表  fig, ax = plt.subplots()  plt.title(u\"商品住宅成交统计数据（武汉）\", fontsize=20)  plt.ylabel(u\"成交量\", fontsize=14)  plt.xlabel(u\"月份\", fontsize=14)  for year, monthly_datas in all_monthly_datas.items():  ax.plot(list(monthly_datas.keys()), list(monthly_datas.values()), label=year)  ax.legend()  plt.show()   # 爬取网页数据（并写入数据库） # html_spider.get_all_daily_datas() html_spider.get_all_monthly_datas() # 读取数据，生成统计图表 generate_plot(db_operator.read_all_monthly_datas()) 执行完毕绘制生成的就是开始贴出的数据图。\n5、简要分析 结合图表中过去两年的数据曲线可以直观的看出，近两年每年都是上半年上涨，随着丈母娘压力逐步降低到年中该买的买了，没买的就是不着急的了，数据会回落然后随着下半年又一拨准备见丈母娘的补充又开始上升。具体来看，2 月份全年最低（猜测是因为过年放寒假），之后稳步上升至 8 月份左右在 9 月份会回落后再次上涨（除了 2018年7月 份也有个明显回落，得查一下是不是当时有政策调控贷款等方面的调整影响）。\n针对看3、4月份，都属于上升区，但全年的高峰其实分别出现在年末与年中。由此可见如果从回暖角度看 ‘金山银四’ 的说法有一定依据，但如果从高峰期角度看则不尽然。\n最终没有得出一个比较肯定的真或假的结论，可能很多事的确是没有明确答案的 ：）\none more thing 2019 年整体还是明显高于 2018 年的，不用太担心楼市走低（担心也没啥用.. 旺柴.jpg\n原本这篇练习的标题应该是 - ‘金九银十’ 是真的吗？硬是被自己拖成了 ‘金三银四’，哎，拖延症要不得。\n以上 祝好\n","wordCount":"572","inLanguage":"en","datePublished":"2020-03-19T22:42:41Z","dateModified":"2020-03-19T22:42:41Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://coderx.wang/posts/python-%E7%BD%91%E9%A1%B5%E6%8A%93%E5%8F%96%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%83%E4%B9%A0%E9%87%91%E4%B8%89%E9%93%B6%E5%9B%9B-%E6%98%AF%E7%9C%9F%E7%9A%84%E5%90%97/"},"publisher":{"@type":"Organization","name":"编程蚂蚁","logo":{"@type":"ImageObject","url":"https://coderx.wang/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://coderx.wang/ accesskey=h title="编程蚂蚁 (Alt + H)">编程蚂蚁</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Python 网页抓取与数据可视化练习：‘金三银四’ 是真的吗？</h1><div class=post-meta><span title="2020-03-19 22:42:41 +0000 UTC">March 19, 2020</span></div></header><div class=post-content><p>一年之计在于春，2020 的春天因为疫情可能改变了许多人的计划，如三四月份是企业传统招聘高峰期之一，再有许多帅小伙过年拜见了丈母娘催促着得买房等，职场与楼市素有 ‘金三银四’ 的说法，然而，这是真的吗？</p><p>最近又学习了一下 Python（为什么是又？因为学了就忘..），想到何不简单验证一下，毕竟数据不会撒谎。</p><blockquote><p>主要流程：</p><ol><li>选取楼市情况作为分析对象，与目前公司业务有点相关性。</li><li>从 <a href=http://fgj.wuhan.gov.cn/>武汉市住房保障和房屋管理局</a> 网站获取公开的新建商品房成交统计数据。</li><li>读取数据并可视化，结合图表简要分析得出初步结论。</li></ol></blockquote><p>先贴最终生成的可视化数据图：</p><p><img loading=lazy src=https://cwblog.oss-cn-hangzhou.aliyuncs.com/images/%e5%95%86%e5%93%81%e4%bd%8f%e5%ae%85%e6%88%90%e4%ba%a4%e7%bb%9f%e8%ae%a1%e6%95%b0%e6%8d%ae%ef%bc%88%e6%ad%a6%e6%b1%89%ef%bc%89.png alt=商品住宅成交统计数据（武汉）></p><h2 id=1获取数据>1、获取数据<a hidden class=anchor aria-hidden=true href=#1获取数据>#</a></h2><p>先使用 ‘为人类设计的 HTTP 库’ - <a href=https://github.com/psf/requests>requests</a> 从房管局网站上获取包含公开成交统计数据的 HTML 页面，数据分为按日统计发布的及按月统计发布的。然后使用 HTML 与 XML 处理库 <a href=https://github.com/lxml/lxml>lxml</a> 解析 HTML 页面内容，分析后通过合适的 xpath 提取所需数据。</p><p>最开始我的想法是读取每日数据再分别计算出每个月的数据，爬完后发现目录页下面紧挨着的就是按月统计数据（笑哭.jpg ，但是按月的数据只发布到了2019年11月，连整两年都凑不足可不行，于是结合按日统计数据（发布到了2020年01月23日）计算出了2019年12月的数据，果然人生没有白走的路：）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lxml.html
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> html
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> db_operator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_all_monthly_datas</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;按月获取所有成交数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 索引页（商品住房销售月度成交统计）</span>
</span></span><span style=display:flex><span>    index_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://fgj.wuhan.gov.cn/spzfxysydjcjb/index.jhtml&#39;</span>
</span></span><span style=display:flex><span>    max_page <span style=color:#f92672>=</span> get_max_page(index_url)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> max_page <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;共 &#39;</span> <span style=color:#f92672>+</span> str(max_page) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; 页，&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;开始获取月度数据..</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> index <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, max_page <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> index <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>                index_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://fgj.wuhan.gov.cn/spzfxysydjcjb/index_&#39;</span> <span style=color:#f92672>+</span> str(index) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.jhtml&#39;</span>
</span></span><span style=display:flex><span>            detail_urls <span style=color:#f92672>=</span> get_detail_urls(index, index_url)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> detail_url <span style=color:#f92672>in</span> detail_urls:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#39;正在获取月度统计详情：&#39;</span> <span style=color:#f92672>+</span> detail_url)
</span></span><span style=display:flex><span>                monthly_detail_html_str <span style=color:#f92672>=</span> request_html(detail_url)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> monthly_detail_html_str:
</span></span><span style=display:flex><span>                    find_and_insert_monthly_datas(monthly_detail_html_str)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;总页数为0。&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>request_html</span>(target_url):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;请求指定 url 页面&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;User-Agent&#39;</span>: <span style=color:#e6db74>&#39;Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Mobile Safari/537.36&#39;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    html_response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(target_url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>    html_bytes <span style=color:#f92672>=</span> html_response<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>    html_str <span style=color:#f92672>=</span> html_bytes<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> html_str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_max_page</span>(index_url) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;从索引页中获取总页数&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;获取总页数中..&#39;</span>)
</span></span><span style=display:flex><span>    index_html_str <span style=color:#f92672>=</span> request_html(index_url)
</span></span><span style=display:flex><span>    selector <span style=color:#f92672>=</span> lxml<span style=color:#f92672>.</span>html<span style=color:#f92672>.</span>fromstring(index_html_str)
</span></span><span style=display:flex><span>    max_page_xpath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;//div[@class=&#34;whj_padding whj_color pages&#34;]/text()&#39;</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> selector<span style=color:#f92672>.</span>xpath(max_page_xpath)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> result <span style=color:#f92672>and</span> len(result) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> result[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        index_str <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>        max_page <span style=color:#f92672>=</span> index_str<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\xa0</span><span style=color:#e6db74>&#39;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        max_page <span style=color:#f92672>=</span> max_page<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;/&#39;</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> int(max_page)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_detail_urls</span>(index, index_url):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;获取统计数据详情页 url 列表&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;正在获取统计列表页面数据:&#39;</span> <span style=color:#f92672>+</span> index_url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    index_html_str <span style=color:#f92672>=</span> request_html(index_url)
</span></span><span style=display:flex><span>    selector <span style=color:#f92672>=</span> lxml<span style=color:#f92672>.</span>html<span style=color:#f92672>.</span>fromstring(index_html_str)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 提取 url 列表。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 疑问：这里使用 &#39;//div[@class=&#34;fr hers&#34;]/ul/li/a/@href&#39; 期望应该能提取到更准确的数据，但是结果为空</span>
</span></span><span style=display:flex><span>    detail_urls_xpath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;//div/ul/li/a/@href&#39;</span>
</span></span><span style=display:flex><span>    detail_urls <span style=color:#f92672>=</span> selector<span style=color:#f92672>.</span>xpath(detail_urls_xpath)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> detail_urls
</span></span></code></pre></div><h2 id=2保存数据>2、保存数据<a hidden class=anchor aria-hidden=true href=#2保存数据>#</a></h2><p>获取到数据后需要保存下来，以便后续的数据处理与增量更新等。这里使用与 Python 相亲相爱的文档型数据库 MongoDB 存储数据。</p><blockquote><p><strong>踩坑</strong>：对于 macOS 系统网上许多 MongoDB 安装说明已经失效，需要参考 <a href=https://github.com/mongodb/homebrew-brew>mongodb/homebrew-brew</a> 引导安装。</p></blockquote><p>启动服务后就可以写入数据：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pymongo <span style=color:#f92672>import</span> MongoClient
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pymongo <span style=color:#f92672>import</span> collection
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pymongo <span style=color:#f92672>import</span> database
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client: MongoClient <span style=color:#f92672>=</span> MongoClient()
</span></span><span style=display:flex><span>db_name: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;housing_deal_data&#39;</span>
</span></span><span style=display:flex><span>col_daily_name: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;wuhan_daily&#39;</span>
</span></span><span style=display:flex><span>col_monthly_name: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;wuhan_monthly&#39;</span>
</span></span><span style=display:flex><span>database: database<span style=color:#f92672>.</span>Database <span style=color:#f92672>=</span> client[db_name]
</span></span><span style=display:flex><span>col_daily: collection <span style=color:#f92672>=</span> database[col_daily_name]
</span></span><span style=display:flex><span>col_monthly: collection <span style=color:#f92672>=</span> database[col_monthly_name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>insert_monthly_data</span>(year_month, monthly_commercial_house):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;写入月度统计数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;year_month&#39;</span>: year_month}
</span></span><span style=display:flex><span>    existed_row <span style=color:#f92672>=</span> col_monthly<span style=color:#f92672>.</span>find_one(query)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        monthly_commercial_house_value <span style=color:#f92672>=</span> int(monthly_commercial_house)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> existed_row:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;月度数据已存在 =&gt;&#39;</span>)
</span></span><span style=display:flex><span>            col_monthly<span style=color:#f92672>.</span>delete_one(query)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;已删除：月度成交数不符合期望。</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;忽略：月度成交数不符合期望。</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(str({year_month: monthly_commercial_house_value}))
</span></span><span style=display:flex><span>        item <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;year_month&#39;</span>: year_month,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;commercial_house&#39;</span>: monthly_commercial_house_value,}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> existed_row:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;月度数据已存在 =&gt;&#39;</span>)
</span></span><span style=display:flex><span>            new_values <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;$set&#39;</span>: item}
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> col_monthly<span style=color:#f92672>.</span>update_one(query, new_values)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;更新数据成功：&#39;</span> <span style=color:#f92672>+</span> str(item) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;result：&#39;</span> <span style=color:#f92672>+</span> str(result) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> col_monthly<span style=color:#f92672>.</span>insert_one(item)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;写入数据成功：&#39;</span> <span style=color:#f92672>+</span> str(item) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;result：&#39;</span> <span style=color:#f92672>+</span> str(result) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span></code></pre></div><p>由于在实践过程中提取数据限制不够严格导致前期写入了一些脏数据，所以这里除了正常的 <em>insert</em>、<em>update</em> 之外，还有一个 <em>try-except</em> 用来清理脏数据。</p><h2 id=3读取数据>3、读取数据<a hidden class=anchor aria-hidden=true href=#3读取数据>#</a></h2><p>获取并保存数据执行完成后，使用 MongoDB GUI 工具 <a href=https://robomongo.org/>Robo 3T</a> 查看，总体确认数据完整基本符合期望。</p><p>接下来从数据库读取数据：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_all_monthly_datas</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;从数据库读取所有月度统计数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;2018年&#34;</span>: read_monthly_datas(<span style=color:#e6db74>&#39;2018&#39;</span>),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;2019年&#34;</span>: read_monthly_datas(<span style=color:#e6db74>&#39;2019&#39;</span>),}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_monthly_datas</span>(year: str) <span style=color:#f92672>-&gt;</span> list:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;从数据库读取指定年份的月度统计数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;year_month&#39;</span>: {<span style=color:#e6db74>&#39;$regex&#39;</span>: <span style=color:#e6db74>&#39;^&#39;</span> <span style=color:#f92672>+</span> year}}
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> col_monthly<span style=color:#f92672>.</span>find(query)<span style=color:#f92672>.</span>limit(<span style=color:#ae81ff>12</span>)<span style=color:#f92672>.</span>sort(<span style=color:#e6db74>&#39;year_month&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    monthly_datas <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> data <span style=color:#f92672>in</span> result:
</span></span><span style=display:flex><span>        year_month <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;year_month&#39;</span>]
</span></span><span style=display:flex><span>        commercial_house <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;commercial_house&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> commercial_house <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            month_key <span style=color:#f92672>=</span> year_month<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;-&#39;</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            monthly_datas[month_key] <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;commercial_house&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 如果读取结果小于 12，即有月度数据缺失，则尝试读取每日数据并计算出该月统计数据</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(monthly_datas) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>12</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> month <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>13</span>):
</span></span><span style=display:flex><span>            month_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{:0&gt;2d}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(month)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> month_key <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> monthly_datas<span style=color:#f92672>.</span>keys():
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>年</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>月 数据缺失..&#39;</span><span style=color:#f92672>.</span>format(year, month_key))
</span></span><span style=display:flex><span>                commercial_house <span style=color:#f92672>=</span> get_month_data_from_daily_datas(year, month_key)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> commercial_house <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                    monthly_datas[month_key] <span style=color:#f92672>=</span> commercial_house
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> monthly_datas
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_month_data_from_daily_datas</span>(year: str, month: str) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;从每日数据中计算月度统计数据&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;从每日数据中获取 </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>年</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>月 数据中..&#39;</span><span style=color:#f92672>.</span>format(year, month))
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;year_month_day&#39;</span>: {<span style=color:#e6db74>&#39;$regex&#39;</span>: <span style=color:#e6db74>&#39;^(</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(year, month)}}
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> col_daily<span style=color:#f92672>.</span>find(query)<span style=color:#f92672>.</span>limit(<span style=color:#ae81ff>31</span>)
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> daily_data <span style=color:#f92672>in</span> result:
</span></span><span style=display:flex><span>        daily_num <span style=color:#f92672>=</span> daily_data[<span style=color:#e6db74>&#39;commercial_house&#39;</span>]
</span></span><span style=display:flex><span>        sum <span style=color:#f92672>+=</span> daily_num
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>年</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>月数据：</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(year, month, sum))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sum
</span></span></code></pre></div><p>可以看到读取月度数据方法中有校验数据是否完整以及数据缺失则从每日数据中读取计算相关的逻辑。</p><h2 id=4数据可视化>4、数据可视化<a hidden class=anchor aria-hidden=true href=#4数据可视化>#</a></h2><p>由于只是练习简单查看数据总体趋势，所以没有想要绘制稍复杂的图表，使用图表库 <a href=https://github.com/matplotlib/matplotlib>matplotlib</a> 绘制简单统计图：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#66d9ef>as</span> plt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> html_spider
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> db_operator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_plot</span>(all_monthly_datas):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;生成统计图表&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 处理汉字未正常显示问题</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 还需要手动下载 SimHei.ttf 字体并放到 /venv/lib/python3.7/site-packages/matplotlib/mpl-data/fonts 目录下）</span>
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>rcParams[<span style=color:#e6db74>&#39;font.sans-serif&#39;</span>] <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;SimHei&#39;</span>]
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>rcParams[<span style=color:#e6db74>&#39;font.family&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;sans-serif&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成统计图表</span>
</span></span><span style=display:flex><span>    fig, ax <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>subplots()
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>title(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;商品住宅成交统计数据（武汉）&#34;</span>, fontsize<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>ylabel(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;成交量&#34;</span>, fontsize<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>xlabel(<span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;月份&#34;</span>, fontsize<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> year, monthly_datas <span style=color:#f92672>in</span> all_monthly_datas<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        ax<span style=color:#f92672>.</span>plot(list(monthly_datas<span style=color:#f92672>.</span>keys()), list(monthly_datas<span style=color:#f92672>.</span>values()), label<span style=color:#f92672>=</span>year)
</span></span><span style=display:flex><span>    ax<span style=color:#f92672>.</span>legend()
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>show()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 爬取网页数据（并写入数据库）</span>
</span></span><span style=display:flex><span><span style=color:#75715e># html_spider.get_all_daily_datas()</span>
</span></span><span style=display:flex><span>html_spider<span style=color:#f92672>.</span>get_all_monthly_datas()
</span></span><span style=display:flex><span><span style=color:#75715e># 读取数据，生成统计图表</span>
</span></span><span style=display:flex><span>generate_plot(db_operator<span style=color:#f92672>.</span>read_all_monthly_datas())
</span></span></code></pre></div><p>执行完毕绘制生成的就是开始贴出的数据图。</p><h2 id=5简要分析>5、简要分析<a hidden class=anchor aria-hidden=true href=#5简要分析>#</a></h2><p>结合图表中过去两年的数据曲线可以直观的看出，近两年每年都是上半年上涨，随着丈母娘压力逐步降低到年中该买的买了，没买的就是不着急的了，数据会回落然后随着下半年又一拨准备见丈母娘的补充又开始上升。具体来看，2 月份全年最低（猜测是因为过年放寒假），之后稳步上升至 8 月份左右在 9 月份会回落后再次上涨（除了 2018年7月 份也有个明显回落，得查一下是不是当时有政策调控贷款等方面的调整影响）。</p><p><em><strong>针对看3、4月份，都属于上升区，但全年的高峰其实分别出现在年末与年中。由此可见如果从回暖角度看 ‘金山银四’ 的说法有一定依据，但如果从高峰期角度看则不尽然。</strong></em></p><p>最终没有得出一个比较肯定的真或假的结论，可能很多事的确是没有明确答案的 ：）</p><h2 id=one-more-thing>one more thing<a hidden class=anchor aria-hidden=true href=#one-more-thing>#</a></h2><p>2019 年整体还是明显高于 2018 年的，不用太担心楼市走低（担心也没啥用.. 旺柴.jpg</p><p>原本这篇练习的标题应该是 - ‘金九银十’ 是真的吗？硬是被自己拖成了 ‘金三银四’，哎，拖延症要不得。</p><p>以上 祝好</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://coderx.wang/tags/python/>Python</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://coderx.wang/>编程蚂蚁</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>